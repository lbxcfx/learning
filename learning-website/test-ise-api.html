<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¯é£è¯­éŸ³è¯„æµ‹APIæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-idle {
            background: #e5e7eb;
        }

        .status-connecting {
            background: #fef3c7;
            color: #92400e;
        }

        .status-recording {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        #log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-error {
            color: #f87171;
        }

        .log-success {
            color: #4ade80;
        }

        .log-info {
            color: #60a5fa;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            width: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¤ è®¯é£è¯­éŸ³è¯„æµ‹APIæµ‹è¯•</h1>

        <div class="test-section">
            <h3>æµ‹è¯•é…ç½®</h3>
            <p>æµ‹è¯•å•è¯: <input type="text" id="testWord" value="hello" /></p>
            <p>APIé…ç½®çŠ¶æ€: <span id="configStatus">æ£€æŸ¥ä¸­...</span></p>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ­¥éª¤</h3>
            <button class="btn-primary" onclick="testWebSocketConnection()">1. æµ‹è¯•WebSocketè¿æ¥</button>
            <button class="btn-success" onclick="startRecordingTest()">2. å¼€å§‹å½•éŸ³æµ‹è¯•</button>
            <button class="btn-danger" onclick="stopRecordingTest()">3. åœæ­¢å½•éŸ³</button>
        </div>

        <div id="status" class="status-idle">çŠ¶æ€: ç­‰å¾…æµ‹è¯•</div>

        <div class="test-section">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div id="log"></div>
        </div>

        <div class="test-section">
            <h3>è¯„æµ‹ç»“æœ</h3>
            <div id="result">ç­‰å¾…è¯„æµ‹...</div>
        </div>
    </div>

    <script src="libs/crypto-js.js"></script>
    <script src="libs/fast-xml-parser.min.js"></script>
    <script src="libs/recorder.umd.js"></script>

    <script>
        // APIé…ç½®
        const ISE_CONFIG = {
            APPID: "47698168",
            API_KEY: "a257644efdfcf97d7446575853cc0b15",
            API_SECRET: "MzMzNmNjZWIzZDYxY2FiM2ZhMjg1Mjhh"
        };

        let recorder = null;
        let iseWS = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function setStatus(message, type = 'idle') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `çŠ¶æ€: ${message}`;
            statusEl.className = `status-${type}`;
        }

        // æ£€æŸ¥é…ç½®
        function checkConfig() {
            const configEl = document.getElementById('configStatus');
            if (ISE_CONFIG.APPID && ISE_CONFIG.API_KEY && ISE_CONFIG.API_SECRET) {
                configEl.innerHTML = `<span style="color: green;">âœ“ å·²é…ç½® (APPID: ${ISE_CONFIG.APPID})</span>`;
                log(`APIé…ç½®å·²åŠ è½½: APPID=${ISE_CONFIG.APPID}`, 'success');
            } else {
                configEl.innerHTML = '<span style="color: red;">âœ— æœªé…ç½®</span>';
                log('APIé…ç½®ç¼ºå¤±!', 'error');
            }
        }

        // ç”ŸæˆWebSocket URL
        function getISEWebSocketUrl() {
            const url = "wss://ise-api.xfyun.cn/v2/open-ise";
            const host = "ise-api.xfyun.cn";
            const apiKey = ISE_CONFIG.API_KEY;
            const apiSecret = ISE_CONFIG.API_SECRET;
            const date = new Date().toGMTString();
            const algorithm = "hmac-sha256";
            const headers = "host date request-line";
            const signatureOrigin = `host: ${host}\ndate: ${date}\nGET /v2/open-ise HTTP/1.1`;

            log(`ç­¾ååŸæ–‡: ${signatureOrigin.replace(/\n/g, '\\n')}`, 'info');

            const signatureSha = CryptoJS.HmacSHA256(signatureOrigin, apiSecret);
            const signature = CryptoJS.enc.Base64.stringify(signatureSha);

            log(`ç­¾åç»“æœ: ${signature}`, 'info');

            const authorizationOrigin = `api_key="${apiKey}", algorithm="${algorithm}", headers="${headers}", signature="${signature}"`;
            const authorization = btoa(authorizationOrigin);

            const finalUrl = `${url}?authorization=${authorization}&date=${encodeURIComponent(date)}&host=${host}`;
            log(`WebSocket URLç”ŸæˆæˆåŠŸ`, 'success');

            return finalUrl;
        }

        // Base64ç¼–ç 
        function toBase64(buffer) {
            let binary = "";
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // æµ‹è¯•WebSocketè¿æ¥
        function testWebSocketConnection() {
            log('=== å¼€å§‹WebSocketè¿æ¥æµ‹è¯• ===', 'info');
            setStatus('æ­£åœ¨è¿æ¥WebSocket...', 'connecting');

            try {
                const wsUrl = getISEWebSocketUrl();
                log(`è¿æ¥åœ°å€: ${wsUrl.substring(0, 100)}...`, 'info');

                const testWS = new WebSocket(wsUrl);

                testWS.onopen = () => {
                    log('WebSocketè¿æ¥æˆåŠŸ!', 'success');
                    setStatus('WebSocketè¿æ¥æˆåŠŸ', 'success');

                    // å‘é€æµ‹è¯•å‚æ•°
                    const testWord = document.getElementById('testWord').value || 'hello';
                    const params = {
                        common: {
                            app_id: ISE_CONFIG.APPID,
                        },
                        business: {
                            category: "read_word",
                            rstcd: "utf8",
                            group: "pupil",
                            sub: "ise",
                            tte: "utf-8",
                            cmd: "ssb",
                            auf: "audio/L16;rate=16000",
                            ent: "en_vip",
                            aus: 1,
                            aue: "raw",
                            text: "\uFEFF" + testWord,
                        },
                        data: {
                            status: 0,
                        },
                    };

                    log(`å‘é€åˆå§‹å‚æ•°: ${JSON.stringify(params)}`, 'info');
                    testWS.send(JSON.stringify(params));
                };

                testWS.onmessage = (e) => {
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${e.data}`, 'success');
                    try {
                        const jsonData = JSON.parse(e.data);
                        if (jsonData.code !== 0) {
                            log(`APIé”™è¯¯: code=${jsonData.code}, message=${jsonData.message}`, 'error');
                            setStatus(`APIé”™è¯¯: ${jsonData.message}`, 'error');
                        } else {
                            log(`APIå“åº”æ­£å¸¸: code=${jsonData.code}`, 'success');
                        }
                    } catch (err) {
                        log(`è§£æå“åº”å¤±è´¥: ${err.message}`, 'error');
                    }
                };

                testWS.onerror = (e) => {
                    log(`WebSocketé”™è¯¯: ${JSON.stringify(e)}`, 'error');
                    setStatus('WebSocketè¿æ¥é”™è¯¯', 'error');
                };

                testWS.onclose = (e) => {
                    log(`WebSocketå…³é—­: code=${e.code}, reason=${e.reason}`, 'info');
                };

            } catch (err) {
                log(`æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
                setStatus('æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // å¼€å§‹å½•éŸ³æµ‹è¯•
        function startRecordingTest() {
            log('=== å¼€å§‹å½•éŸ³æµ‹è¯• ===', 'info');
            setStatus('æ­£åœ¨åˆå§‹åŒ–å½•éŸ³...', 'connecting');

            try {
                // åˆå§‹åŒ–å½•éŸ³å™¨
                if (!recorder) {
                    log('åˆå§‹åŒ–RecorderManager...', 'info');
                    recorder = new RecorderManager("libs");
                    recorder.onStart = () => {
                        log('å½•éŸ³å·²å¼€å§‹', 'success');
                        setStatus('æ­£åœ¨å½•éŸ³...', 'recording');
                    };
                    recorder.onStop = () => {
                        log('å½•éŸ³å·²åœæ­¢', 'info');
                    };
                }

                const testWord = document.getElementById('testWord').value || 'hello';
                log(`æµ‹è¯•å•è¯: ${testWord}`, 'info');

                // è¿æ¥WebSocket
                const wsUrl = getISEWebSocketUrl();
                iseWS = new WebSocket(wsUrl);

                iseWS.onopen = () => {
                    log('WebSocketå·²è¿æ¥ï¼Œå¼€å§‹å½•éŸ³...', 'success');

                    // å¼€å§‹å½•éŸ³
                    recorder.start({
                        sampleRate: 16000,
                        frameSize: 1280,
                    });

                    // å‘é€åˆå§‹å‚æ•°
                    const params = {
                        common: {
                            app_id: ISE_CONFIG.APPID,
                        },
                        business: {
                            category: "read_word",
                            rstcd: "utf8",
                            group: "pupil",
                            sub: "ise",
                            tte: "utf-8",
                            cmd: "ssb",
                            auf: "audio/L16;rate=16000",
                            ent: "en_vip",
                            aus: 1,
                            aue: "raw",
                            text: "\uFEFF" + testWord,
                        },
                        data: {
                            status: 0,
                        },
                    };

                    iseWS.send(JSON.stringify(params));
                    log('åˆå§‹å‚æ•°å·²å‘é€', 'info');
                };

                iseWS.onmessage = (e) => {
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${e.data.substring(0, 200)}...`, 'info');
                    handleISEResult(e.data);
                };

                iseWS.onerror = (e) => {
                    log(`WebSocketé”™è¯¯!`, 'error');
                    setStatus('è¿æ¥é”™è¯¯', 'error');
                };

                iseWS.onclose = (e) => {
                    log(`WebSocketå…³é—­`, 'info');
                    if (recorder) {
                        recorder.stop();
                    }
                };

                // è®¾ç½®éŸ³é¢‘å¸§å›è°ƒ
                recorder.onFrameRecorded = ({ isLastFrame, frameBuffer }) => {
                    if (iseWS && iseWS.readyState === WebSocket.OPEN) {
                        const frameData = {
                            business: {
                                aue: "raw",
                                cmd: "auw",
                                aus: isLastFrame ? 4 : 2,
                            },
                            data: {
                                status: isLastFrame ? 2 : 1,
                                data: toBase64(frameBuffer),
                                data_type: 1
                            },
                        };
                        iseWS.send(JSON.stringify(frameData));
                        log(`å‘é€éŸ³é¢‘å¸§: ${frameBuffer.byteLength} bytes, isLast=${isLastFrame}`, 'info');
                    }
                };

            } catch (err) {
                log(`å½•éŸ³æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
                setStatus('å½•éŸ³æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecordingTest() {
            log('åœæ­¢å½•éŸ³...', 'info');
            if (recorder) {
                recorder.stop();
            }
            setStatus('å½•éŸ³å·²åœæ­¢ï¼Œç­‰å¾…è¯„æµ‹ç»“æœ...', 'connecting');
        }

        // å¤„ç†ISEç»“æœ
        function handleISEResult(resultData) {
            try {
                const jsonData = JSON.parse(resultData);

                if (jsonData.code !== 0) {
                    log(`APIé”™è¯¯: code=${jsonData.code}, message=${jsonData.message}`, 'error');
                    document.getElementById('result').innerHTML = `<span style="color: red;">é”™è¯¯: ${jsonData.message}</span>`;
                    return;
                }

                if (jsonData.data && jsonData.data.data) {
                    const data = window.atob(jsonData.data.data);
                    log(`åŸå§‹XMLæ•°æ®: ${data}`, 'info');

                    const parser = new XMLParser({
                        attributeNamePrefix: "",
                        ignoreAttributes: false,
                    });
                    const grade = parser.parse(data);

                    log(`è§£æç»“æœ: ${JSON.stringify(grade)}`, 'success');

                    // æå–è¯„åˆ†
                    const readWord = grade?.xml_result?.read_word?.rec_paper?.read_chapter;
                    if (readWord) {
                        const totalScore = readWord.total_score || 0;
                        const accuracyScore = readWord.accuracy_score || 0;
                        const fluencyScore = readWord.fluency_score || 0;

                        document.getElementById('result').innerHTML = `
              <div style="padding: 15px; background: #d1fae5; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">âœ“ è¯„æµ‹æˆåŠŸ!</h4>
                <p><strong>æ€»åˆ†:</strong> ${totalScore}</p>
                <p><strong>å‡†ç¡®åº¦:</strong> ${accuracyScore}</p>
                <p><strong>æµç•…åº¦:</strong> ${fluencyScore}</p>
              </div>
            `;
                        setStatus('è¯„æµ‹å®Œæˆ', 'success');
                    }
                }

                if (jsonData.data && jsonData.data.status === 2) {
                    log('è¯„æµ‹ç»“æŸ', 'success');
                    if (iseWS) {
                        iseWS.close();
                    }
                }

            } catch (err) {
                log(`è§£æç»“æœå¤±è´¥: ${err.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥é…ç½®
        window.onload = () => {
            checkConfig();
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('è¯·æŒ‰é¡ºåºç‚¹å‡»æµ‹è¯•æŒ‰é’®', 'info');
        };
    </script>
</body>

</html>