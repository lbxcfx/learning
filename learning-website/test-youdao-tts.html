<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youdao TTS API Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        input,
        textarea,
        button {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
        }

        #log {
            background: #f0f0f0;
            padding: 10px;
            white-space: pre-wrap;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Youdao TTS API Debugger</h2>

        <label>App Key:</label>
        <input type="text" id="appKey" value="1a88c11a7e8767f3">

        <label>App Secret:</label>
        <input type="text" id="appSecret" value="jnAEoemgbmkIl5dzdmWlsPeItwiFa2n2">

        <label>Text to Speech:</label>
        <textarea id="text">We should eat more vegetables.</textarea>

        <button onclick="testTTS()">Generate Audio</button>

        <h3>Log:</h3>
        <div id="log"></div>

        <h3>Audio:</h3>
        <audio id="audioPlayer" controls></audio>
    </div>

    <script>
        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerText += msg + '\n';
            console.log(msg);
        }

        function truncate(q) {
            const len = q.length;
            if (len <= 20) return q;
            return q.substring(0, 10) + len + q.substring(len - 10, len);
        }

        async function testTTS() {
            document.getElementById('log').innerText = '';
            const appKey = document.getElementById('appKey').value.trim();
            const appSecret = document.getElementById('appSecret').value.trim();
            const q = document.getElementById('text').value.trim();

            if (!appKey || !appSecret || !q) {
                log('Error: Missing credentials or text.');
                return;
            }

            const salt = createUUID();
            const curtime = Math.round(new Date().getTime() / 1000).toString();
            const input = truncate(q);

            const signStr = appKey + input + salt + curtime + appSecret;
            const sign = CryptoJS.SHA256(signStr).toString(CryptoJS.enc.Hex);

            log('--- Request Parameters ---');
            log(`AppKey: ${appKey}`);
            log(`Q (raw): ${q}`);
            log(`Input (truncated): ${input}`);
            log(`Salt: ${salt}`);
            log(`Curtime: ${curtime}`);
            log(`SignStr: ${signStr}`);
            log(`Sign: ${sign}`);

            const formData = new URLSearchParams();
            formData.append('q', q);
            formData.append('langType', 'en');
            formData.append('appKey', appKey);
            formData.append('salt', salt);
            formData.append('curtime', curtime);
            formData.append('sign', sign);
            formData.append('signType', 'v3');
            // formData.append('format', 'mp3'); // Optional

            try {
                log('Sending request to https://openapi.youdao.com/ttsapi...');
                const response = await fetch('https://openapi.youdao.com/ttsapi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                log(`Response Status: ${response.status}`);

                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`);

                if (contentType && contentType.includes('audio')) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    document.getElementById('audioPlayer').src = url;
                    document.getElementById('audioPlayer').play();
                    log('Success: Audio loaded.');
                } else {
                    const text = await response.text();
                    log(`Error Response Body: ${text}`);
                }

            } catch (e) {
                log(`Network/Script Error: ${e.message}`);
            }
        }

        function createUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    </script>
</body>

</html>