<!--pages/learn/learn.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨è¿›åº¦æ¡ -->
  <view class="progress-bar">
    <view class="progress-fill" style="width: {{progress}}%"></view>
  </view>
  <view class="progress-info">
    <text class="progress-text">{{currentIndex + 1}} / {{totalItems}}</text>
    <text class="score-text">ğŸª™ {{score}}</text>
  </view>
  
  <!-- å•è¯å¡ç‰‡æ¨¡å¼ -->
  <view class="game-content" wx:if="{{mode === 'vocab'}}">
    <view class="vocab-card {{isFlipped ? 'flipped' : ''}}" bindtap="flipCard">
      <view class="card-front">
        <text class="word-emoji">{{currentWord.emoji || 'ğŸ“'}}</text>
        <text class="word-english">{{currentWord.english}}</text>
        <text class="word-soundmark">{{currentWord.soundmark}}</text>
        <button class="sound-btn" catchtap="playSound">ğŸ”Š å¬å‘éŸ³</button>
      </view>
      <view class="card-back">
        <text class="word-chinese">{{currentWord.chinese}}</text>
        <text class="word-soundmark">{{currentWord.soundmark}}</text>
        <text class="word-english-small">{{currentWord.english}}</text>
      </view>
    </view>
    
    <view class="bottom-section">
      <text class="tip">ğŸ‘† ç‚¹å‡»å¡ç‰‡ç¿»è½¬æŸ¥çœ‹ä¸­æ–‡é‡Šä¹‰</text>
      
      <view class="nav-buttons">
        <button class="nav-btn secondary" bindtap="prevItem" disabled="{{currentIndex === 0}}">â† ä¸Šä¸€ä¸ª</button>
        <button class="nav-btn primary" bindtap="nextItem">
          {{currentIndex === totalItems - 1 ? 'å®Œæˆ âœ“' : 'ä¸‹ä¸€ä¸ª â†’'}}
        </button>
      </view>
      
      <!-- å­¦ä¹ å°è´´å£« -->
      <view class="learning-tips">
        <view class="tips-header">
          <text class="tips-icon">ğŸ’¡</text>
          <text class="tips-title">å­¦ä¹ å°è´´å£«</text>
        </view>
        <text class="tips-content">åå¤æœ—è¯»å•è¯3éï¼Œè®°å¿†æ›´ç‰¢å›ºå“¦ï¼</text>
      </view>
    </view>
  </view>
  
  <!-- çœ‹å›¾é€‰è¯æ¨¡å¼ -->
  <view class="game-content" wx:if="{{mode === 'match'}}">
    <!-- é¢˜ç›®å¡ç‰‡ -->
    <view class="match-card">
      <view class="match-header">
        <text class="match-label">çœ‹å›¾è¯†å•è¯</text>
      </view>
      <text class="match-emoji">{{currentWord.emoji || 'ğŸ“'}}</text>
      <text class="match-chinese-hint">{{currentWord.chinese}}</text>
      <button class="sound-btn-large" bindtap="playSound">ğŸ”Š å¬å‘éŸ³</button>
    </view>
    
    <!-- é€‰é¡¹åŒºåŸŸ -->
    <view class="options-section">
      <text class="options-label">é€‰æ‹©æ­£ç¡®çš„å•è¯ï¼š</text>
      <view class="options-grid">
        <view 
          class="option-card {{item.selected ? (item.correct ? 'correct' : 'wrong') : ''}}"
          wx:for="{{options}}"
          wx:key="english"
          bindtap="selectOption"
          data-index="{{index}}"
        >
          <text class="option-text">{{item.english}}</text>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æç¤º -->
    <view class="learning-tips match-tips">
      <view class="tips-header">
        <text class="tips-icon">ğŸ’¡</text>
        <text class="tips-title">å°æŠ€å·§</text>
      </view>
      <text class="tips-content">çœ‹å›¾è”æƒ³ï¼Œè®°å¿†æ›´æ·±åˆ»ï¼</text>
    </view>
  </view>

  <!-- å£è¯­ç»ƒä¹ æ¨¡å¼ -->
  <view class="game-content" wx:if="{{mode === 'oral'}}">
    <view class="match-card">
      <view class="match-header">
        <text class="match-label">å£è¯­ç»ƒä¹ </text>
      </view>
      <text class="match-emoji">{{currentWord.emoji || 'ğŸ“'}}</text>
      <text class="match-chinese-hint">{{currentWord.chinese}}</text>
      <text class="match-word-english" style="font-size: 48rpx; color: #4b5563; margin-top: 20rpx; font-weight: bold;">{{currentWord.english}}</text>
      <button class="sound-btn-large" bindtap="playSound">ğŸ”Š å¬æ ‡å‡†éŸ³</button>
    </view>
    
    <view class="oral-section" style="margin-top: 60rpx; display: flex; flex-direction: column; align-items: center;">
        <view class="oral-status" style="margin-bottom: 30rpx; color: #6b7280; font-size: 28rpx;">
            <text wx:if="{{oral.status === 'IDLE'}}">ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£å¼€å§‹å½•éŸ³</text>
            <text wx:if="{{oral.status === 'CONNECTING'}}">æ­£åœ¨è¿æ¥...</text>
            <text wx:if="{{oral.status === 'RECORDING'}}">æ­£åœ¨å½•éŸ³... ç‚¹å‡»åœæ­¢</text>
            <text wx:if="{{oral.status === 'EVALUATING'}}">æ­£åœ¨è¯„æµ‹...</text>
        </view>
        
        <view class="record-btn {{oral.status === 'RECORDING' ? 'recording' : ''}}" 
              bindtap="toggleRecord"
              style="width: 140rpx; height: 140rpx; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); transition: all 0.3s ease; position: relative;">
            <text style="font-size: 60rpx;">ğŸ¤</text>
            <view class="ripple" wx:if="{{oral.status === 'RECORDING'}}" 
                  style="position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 4rpx solid #10b981; animation: ripple 1.5s infinite;"></view>
        </view>

        <view class="result-display" wx:if="{{oral.score > 0}}" style="margin-top: 40rpx;">
            <text class="result-score" style="font-size: 36rpx; font-weight: bold; color: {{oral.isCorrect ? '#10b981' : '#ef4444'}};">å¾—åˆ†: {{oral.score}}</text>
        </view>
    </view>
  </view>
  
  <!-- å¥å­æ’åºæ¨¡å¼ -->
  <view class="game-content" wx:if="{{mode === 'sentence'}}">
    <!-- é¢˜ç›®åŒºåŸŸ -->
    <view class="sentence-card">
      <view class="sentence-header">
        <text class="sentence-label">ğŸ”€ å¥å­æ’åº</text>
      </view>
      <text class="sentence-chinese-main">{{currentSentence.chinese}}</text>
      <button class="sound-btn-sentence" bindtap="playSentenceSound">ğŸ”Š å¬å¥å­å‘éŸ³</button>
    </view>
    
    <!-- ç­”æ¡ˆåŒºåŸŸ -->
    <view class="answer-section">
      <text class="section-label">æ‹¼å‡ºè‹±æ–‡å¥å­ï¼š</text>
      <view class="dropzone">
        <text wx:if="{{placedWords.length === 0}}" class="placeholder">ğŸ‘† ç‚¹å‡»ä¸‹æ–¹å•è¯ç»„æˆå¥å­</text>
        <view 
          class="placed-word"
          wx:for="{{placedWords}}"
          wx:key="index"
          bindtap="removeWord"
          data-index="{{index}}"
        >
          {{item}}
        </view>
      </view>
    </view>
    
    <!-- å•è¯æ±  -->
    <view class="pool-section">
      <text class="section-label">å¯é€‰å•è¯ï¼š</text>
      <view class="word-pool">
        <view 
          class="word-chip {{item.placed ? 'placed' : ''}}"
          wx:for="{{shuffledWords}}"
          wx:key="index"
          bindtap="placeWord"
          data-index="{{index}}"
        >
          {{item.word}}
        </view>
      </view>
    </view>
    
    <button 
      class="check-btn" 
      bindtap="checkSentence" 
      disabled="{{placedWords.length !== correctOrder.length}}"
    >
      âœ… æ£€æŸ¥ç­”æ¡ˆ
    </button>
    
    <!-- åº•éƒ¨æç¤º -->
    <view class="learning-tips sentence-tips">
      <view class="tips-header">
        <text class="tips-icon">ğŸ’¡</text>
        <text class="tips-title">è¯­æ³•å°çŸ¥è¯†</text>
      </view>
      <text class="tips-content">æ³¨æ„è‹±æ–‡å¥å­çš„è¯­åºï¼šä¸»è¯­+è°“è¯­+å®¾è¯­</text>
    </view>
  </view>

  <!-- å¡«ç©ºé€‰æ‹©æ¨¡å¼ -->
  <view class="game-content" wx:if="{{mode === 'fill'}}">
    <view class="fill-container">
      <view class="sentence-chinese">{{currentSentence.chinese}}</view>
      
      <!-- å¥å­æ˜¾ç¤ºåŒºåŸŸ (ä½¿ç”¨Flexå¸ƒå±€è§£å†³ç©ºæ ¼å’Œæ’ç‰ˆé—®é¢˜) -->
      <view class="fill-sentence-wrapper">
        <block wx:for="{{fillSentence}}" wx:key="index">
          <!-- å¡«ç©ºé¡¹ -->
          <view wx:if="{{index === fillBlankIndex}}" class="fill-blank-wrapper">
            <text class="fill-blank {{fillDisplayWord !== '_____' ? 'filled' : ''}}">{{fillDisplayWord === '_____' ? '' : fillDisplayWord}}</text>
            <view class="fill-line" wx:if="{{fillDisplayWord === '_____'}}"></view>
          </view>
          <!-- æ™®é€šå•è¯ -->
          <text wx:else class="fill-word">{{item}}</text>
        </block>
      </view>
      
      <view class="fill-options-container">
        <text class="options-label">è¯·é€‰æ‹©æ­£ç¡®çš„å•è¯ï¼š</text>
        <view class="fill-options">
          <button 
            class="fill-option {{item.selected ? (item.correct ? 'correct' : 'wrong') : ''}}"
            wx:for="{{fillOptions}}"
            wx:key="text"
            bindtap="checkFillAnswer"
            data-index="{{index}}"
          >
            {{item.text}}
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- é™æ—¶æŒ‘æˆ˜æ¨¡å¼ -->
  <view class="game-content" wx:if="{{mode === 'challenge'}}">
    <view class="challenge-header">
      <view class="timer-badge {{challenge.timer <= 10 ? 'urgent' : ''}}">
        â±ï¸ {{challenge.timer}}s
      </view>
      <view class="score-badge">
        âœ… {{challenge.correctCount}} / {{challenge.totalCount}}
      </view>
    </view>

    <!-- å¤ç”¨çœ‹å›¾é€‰è¯UI (ä½¿ç”¨ correct çš„æ ·å¼ç±») -->
    <view class="match-card challenge-card">
      <view class="match-header">
        <text class="match-label">é™æ—¶æŒ‘æˆ˜</text>
      </view>
      <text class="match-emoji">{{challenge.currentQuestion.data.emoji || 'ğŸ“'}}</text>
      <!-- æ˜¾ç¤ºä¸­æ–‡æç¤ºï¼Œå¢åŠ å‹å¥½åº¦ -->
      <text class="match-chinese-hint">{{challenge.currentQuestion.data.chinese}}</text>
      
      <view class="options-section">
        <view class="options-grid">
          <view 
            class="option-card {{item.selected ? (item.correct ? 'correct' : 'wrong') : ''}}"
            wx:for="{{options}}"
            wx:key="english"
            bindtap="checkChallengeAnswer"
            data-index="{{index}}"
          >
            <text class="option-text">{{item.english}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
  <!-- åé¦ˆå¼¹çª— -->
  <view class="feedback-overlay {{feedback.show ? 'show' : ''}}">
    <view class="feedback-card {{feedback.success ? 'success' : 'error'}}">
      <text class="feedback-icon">{{feedback.success ? 'ğŸ‰' : 'ğŸ’ª'}}</text>
      <text class="feedback-title">{{feedback.title}}</text>
      <text class="feedback-message">{{feedback.message}}</text>
    </view>
  </view>
</view>
